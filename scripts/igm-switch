#!/usr/bin/env bash

DOTFILES=$HOME/dotfiles
cd $DOTFILES

# Check for uncommitted changes in dotfiles repo
# Nix flakes only see committed files, so uncommitted changes won't be included in the build
if ! git diff --quiet || ! git diff --cached --quiet; then
	echo -e "\033[1;31mError:\033[0m There are uncommitted changes in the dotfiles repo."
	echo -e "\033[33mNix only works on Git inputs, so uncommitted changes won't be included in the build.\033[0m"
	echo -e "Please commit your changes first."
	exit 1
fi

source $DOTFILES/scripts/igm-helpers.sh
FLAKE_PATH=$(flake_path)
SYSTEM_CONFIG_ATTRIBUTE=$(system_config_attribute)
echo "Using flake at path $FLAKE_PATH."

echo "Synchronizing settings"
# igm-sync

SHOW_TRACE=''
if [ "${1:none}" = '--debug' ]; then
	SHOW_TRACE='--show-trace'
fi

echo "Updating private dotfiles."
cd $HOME/dotfiles-private && git add -A . && git commit -m "Updates" && git frp

cd $DOTFILES

echo "Updating igm and dotfiles-private-raw flakes."
nix flake update igm dotfiles-private-raw --flake $FLAKE_PATH

if $(uname -a | grep -q "NixOS"); then
	sudo nixos-rebuild switch --impure --flake "$FLAKE_PATH#$SYSTEM_CONFIG_ATTRIBUTE" $SHOW_TRACE
fi

if $(uname -a | grep -q "Darwin"); then
	nix build "$FLAKE_PATH#$SYSTEM_CONFIG_ATTRIBUTE" $SHOW_TRACE || exit 1
	sudo ./result/sw/bin/darwin-rebuild switch --flake "$FLAKE_PATH#$(hostname)"
	rm -r result
fi
