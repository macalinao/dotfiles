#!/usr/bin/env bash
set -e

DOTFILES="${DOTFILES:-$HOME/dotfiles}"
SETTINGS_FILE="$DOTFILES/config/claude/settings.json"

CLAUDE_DIRS=(
	"$HOME/.claude"
	"$HOME/.claude-2"
	"$HOME/.claude-3"
)

if [ ! -f "$SETTINGS_FILE" ]; then
	echo "No config/claude/settings.json found in dotfiles"
	exit 1
fi

for dir in "${CLAUDE_DIRS[@]}"; do
	if [ -d "$dir" ]; then
		if [ -f "$dir/settings.json" ] && ! diff -q "$SETTINGS_FILE" "$dir/settings.json" >/dev/null 2>&1; then
			echo "Changes for $dir/settings.json:"
			diff "$dir/settings.json" "$SETTINGS_FILE" || true
			echo ""
		fi
		echo "Deploying to $dir/settings.json"
		cp "$SETTINGS_FILE" "$dir/settings.json"

		# Add igm-plugins marketplace if not present
		if ! CLAUDE_CONFIG_DIR="$dir" claude plugin marketplace list 2>/dev/null | grep -q "macalinao/claude-plugin"; then
			echo "Adding macalinao/claude-plugin marketplace to $dir"
			CLAUDE_CONFIG_DIR="$dir" claude plugin marketplace add macalinao/claude-plugin
		fi

		# Add ast-grep marketplace if not present
		if ! CLAUDE_CONFIG_DIR="$dir" claude plugin marketplace list 2>/dev/null | grep -q "ast-grep/claude-skill"; then
			echo "Adding ast-grep/claude-skill marketplace to $dir"
			CLAUDE_CONFIG_DIR="$dir" claude plugin marketplace add ast-grep/claude-skill
		fi
	fi
done

echo "Done."
